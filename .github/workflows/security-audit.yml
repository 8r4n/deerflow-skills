# Security Audit — SBOM generation and vulnerability scanning for skill images
#
# Runs anchore/sbom-action (Syft) to generate a Software Bill of Materials and
# anchore/scan-action (Grype) to report vulnerabilities for every skill whose
# Dockerfile changed, or for a manually-specified skill.
#
# Behaviour
#   • On pull_request / push: detects which skills changed and scans each one.
#   • On workflow_dispatch: scans a single, user-supplied skill name.
#   • SBOM (SPDX JSON) and Grype SARIF/table reports are uploaded as artifacts.
#   • Critical severity vulnerabilities cause the job to fail, blocking
#     skill acquisition until they are mitigated.

name: Security Audit

on:
  pull_request:
    paths:
      - "skills/**"
  push:
    branches: [main]
    paths:
      - "skills/**"
  workflow_dispatch:
    inputs:
      skill_name:
        description: "Skill folder name under skills/ (e.g., my-skill)"
        required: true

permissions:
  contents: read
  security-events: write   # required to upload SARIF results

jobs:
  detect-skills:
    name: Detect changed skills
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Build skill matrix
        id: set-matrix
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger — scan only the supplied skill
            SKILLS='["${{ inputs.skill_name }}"]'
          else
            # Detect skills whose files changed in this push/PR
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE="${{ github.event.pull_request.base.sha }}"
              HEAD="${{ github.event.pull_request.head.sha }}"
            fi

            CHANGED=$(git diff --name-only "$BASE" "$HEAD" 2>/dev/null \
              | grep '^skills/' \
              | awk -F'/' '{print $2}' \
              | sort -u \
              | grep -v '^_template$' || true)

            if [ -z "$CHANGED" ]; then
              echo "No skill changes detected."
              echo 'matrix=[]' >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Build JSON array
            SKILLS=$(printf '%s\n' $CHANGED | jq -R . | jq -sc .)
          fi

          echo "matrix=$SKILLS" >> "$GITHUB_OUTPUT"
          echo "Skills to audit: $SKILLS"

  audit:
    name: Audit ${{ matrix.skill }}
    needs: detect-skills
    if: needs.detect-skills.outputs.matrix != '[]' && needs.detect-skills.outputs.matrix != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        skill: ${{ fromJson(needs.detect-skills.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate skill directory
        run: |
          SKILL_DIR="skills/${{ matrix.skill }}"
          if [ ! -d "$SKILL_DIR" ]; then
            echo "::error::Skill directory '$SKILL_DIR' does not exist."
            exit 1
          fi
          if [ ! -f "$SKILL_DIR/Dockerfile" ]; then
            echo "::error::No Dockerfile found at '$SKILL_DIR/Dockerfile'."
            exit 1
          fi

      - name: Build skill image
        run: |
          docker build \
            -t "deerflow-skill-${{ matrix.skill }}:audit" \
            "skills/${{ matrix.skill }}"

      # ── SBOM generation (Syft) ──────────────────────────────────────────────
      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0.23.0
        with:
          image: "deerflow-skill-${{ matrix.skill }}:audit"
          artifact-name: "sbom-${{ matrix.skill }}.spdx.json"
          output-file: "/tmp/sbom-${{ matrix.skill }}.spdx.json"
          format: spdx-json

      # ── Vulnerability scan (Grype) ──────────────────────────────────────────
      - name: Scan for vulnerabilities with Grype
        id: grype
        uses: anchore/scan-action@v7.3.2
        with:
          image: "deerflow-skill-${{ matrix.skill }}:audit"
          output-format: sarif
          severity-cutoff: critical
          fail-build: true

      - name: Upload Grype SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
          category: "grype-${{ matrix.skill }}"

      # ── Human-readable table report ─────────────────────────────────────────
      - name: Generate Grype table report
        if: always()
        uses: anchore/scan-action@v7.3.2
        with:
          image: "deerflow-skill-${{ matrix.skill }}:audit"
          output-format: table
          severity-cutoff: critical
          fail-build: false

      # ── Upload artifacts ────────────────────────────────────────────────────
      - name: Upload SBOM artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "sbom-${{ matrix.skill }}"
          path: "/tmp/sbom-${{ matrix.skill }}.spdx.json"
          retention-days: 90
